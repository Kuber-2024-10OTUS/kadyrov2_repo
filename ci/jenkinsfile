pipeline {
    agent any // Выбираем Jenkins агента, на котором будет происходить сборка: нам нужен любой

    triggers {
        pollSCM('H/5 * * * *') // Запускать будем автоматически по крону примерно раз в 5 минут
    }

    // tools {
    //     maven 'maven-3.8.1' // Для сборки бэкенда нужен Maven
    //     // jdk 'jdk16' // И Java Developer Kit нужной версии
    //     nodejs 'node-16' // А NodeJS нужен для фронта
    // }

    stages {
        // stage('install tools' ) {
        //     steps {
        //         sh 'sudo apt install maven -y'
        //          sh 'mvn -v'
        //        curl -sL https://deb.nodesource.com/setup_16.x | sudo bash -
                    // sudo apt -y install nodejs
               // curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          //          which yc
        //     }
        // }


        // stage('Build & Test backend') {
        //     steps {
        //         dir("backend") { // Переходим в папку backend
        //             sh 'mvn package' // Собираем мавеном бэкенд
        //         }
        //     }

        //     post {
        //         success {
        //             junit 'backend/target/surefire-reports/**/*.xml' // Передадим результаты тестов в Jenkins
        //         }
        //     }
        // }

            stage('Build frontend') {
                steps {
                    dir("frontend") {
                        sh 'npm install' // Для фронта сначала загрузим все сторонние зависимости
                        sh 'npm run build' // Запустим сборку
                    }
                }
            }
        
           stage('Push artifacts') {
           steps {
                  
                withCredentials([string(credentialsId: 'sudo-password', variable: 'SUDO_PASSWORD')]) {
                    sh '''
                         echo $SUDO_PASSWORD | sudo -S    yc storage s3api put-object \
                        --bucket tim-bucket \
                        --key /storage/yandex-cloud \
                        --body /home/tim13/yandex-cloud  \
                        --metadata "Content-Type=text/plain,Cache-Control=max-age=3600"
                    '''

                    //   echo $SUDO_PASSWORD | sudo -S /home/tim13/yandex-cloud/bin/yc  storage bucket update tim-bucket --path ./dist/ --key dist/
                }
            }
            // post {
            //     success {
            //         sh ("""curl -X POST -H 'Content-type: application/json' \
            //         --data '{"chat_id": "-1002348770467", "text": "Хасанов Булат собрал приложение."}' \
            //         https://api.telegram.org/bot5933756043:AAE8JLL5KIzgrNBeTP5e-1bkbJy4YRoeGjs/sendMessage """)
            //     }
            // }
        }
    }
}